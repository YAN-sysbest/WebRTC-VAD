## 1.VAD算法

### 1.VAD介绍

#### 1.VAD概念

VAD的作用是从一段语音（纯净或带噪）信号中标识出语音片段与非语音片段。VAD系统通常包括两个部分，特征提取和语音/非语音判决；

#### 2.常用特征

常用的特征提取可以分为五类：

- 基于能量：基于能量的准则是检测信号的强度，并且假设语音能量大于背景噪声能量，这样当能量大于某一门限时，可以认为有语音存在。然而当噪声大到和语音一样时，能量这个特征无法区分语音还是纯噪声。早先基于能量的方法，将宽带语音分成各个子带，在子带上求能量；因为语音在2KHz以下频带包含大量的能量，而噪声在24KHz或者4KHz以上频带比02HKz频带倾向有更高的能量。这其实就是频谱平坦度的概念，webrtc中已经用到了。在信噪比低于10dB时，语音和噪声的区分能力会加速下降。
- 频域：通过STFT将时域信号变成频域信号，即使在SNR到0dB时，一些频带的长时包络还是可以区分语音和噪声。

- 倒谱：对于VAD，能量倒谱峰值确定了语音信号的基频(pitch)，也有使用MFCC做为特征的;
- 谐波：语音的一个明显特征是包含了基频F0 及其多个谐波频率，即使在强噪声场景，谐波这一特征也是存在的。可以使用自相关的方法找到基频。
- 长时信息：语音是非稳态信号。普通语速通常每秒发出10~15个音素，音素见的谱分布是不一样的，这就导致了随着时间变化语音统计特性也是变化的。另一方面，日常的绝大多数噪声是稳态的（变化比较慢的），如白噪声/机器噪声。

#### 3.判决准则

判决准则可以分为三类：

- 基于门限
- 统计模型
- 机器学习

### 2.WebRTC算法

#### 1.WebRTC的VAD处理流程

- 进行一些基本的检测，检测VAD结构体是否被初始化，语音帧长度是否满足条件。
- 对高采样频率的语音进行下采样，均采样到8kHz。
- 将语音信号频谱分割为6个子带，分别计算这6个子带的对数能量作为GMM相关特征。还计算整体的频带能量total_energy用于计算GMM。（WebRtcVad_CalculateFeatures）
- **核心算法**：根据GMM模型，判断语音噪声标志，并更新模型参数。（WebRtcVad_GmmProbability）

#### 2.处理相关说明

##### 1.下采样：

以48kHz下采样到8kHz为例(WebRtcSpl_Resample48khzTo8khz)：首先48kHz下采样到24kHz，然后对24kHz的语音数据进行低通滤波(这一步并不改变采样率)，后面继续进行下采样24kHz->16kHz，16kHz->8kHz，最终得到8kHz的语音数据。

##### 2.子带分割(filter_bank.c)

首先将4kHz的数据分为0\~2kHz和2k\~4kHz，然后将2k\~4kHz部分划分为2k\~3kHz和3k\~4kHz两部分。0\~2kHz中则先分为0\~1kHz和1k\~2kHz两部分，其中0\~1kHz再分为0\~250Hz和250\~500Hz，最后对0\~250Hz部分进行80Hz高通滤波得到80\~250Hz的部分，至此得到六个子带：80\~250Hz，250\~500Hz，500\~1kHz，1k\~2kHz，2k\~3kHz，3k\~4kHz六个子带。取80Hz以上是由于我国居民用电为220V/50Hz，50Hz干扰会混入麦克风采集到的信号中。

##### 3.GMM模型(GmmProbability)

（1）根据帧长度设置各种阈值（用于鲁棒性输出和vad判断）

（2）total_power>kMinEnergy，帧总能量大于触发音频信号所需的最低能量，才进行后面步骤。

（3）计算模型输出判决，对于每一子带进行如下处理：

- 计算基于语音混合高斯模型的语音的概率P(X|H1)；计算基于噪声混合高斯模型的噪声的概率P(X|H0)；
- 根据语音概率和噪声概率，采用基于假设的似然比检验（LRT），计算语音与噪声的子带似然比，当其中某一子带似然比满足子带阈值，则判决为语音；
- 加权累加每一个子带的似然比得到整体似然比，判断整体似然比满足整体阈值，则判决为语音；
- 计算噪声H0和语音H1的每个高斯模型的条件概率分别存放在ngprevc和sgprvec两个向量里（用于模型参数的更新）

（4）更新模型参数，对每一子带做如下处理：

- 调用WebRtcVad_FindMinimum()函数对每个特征，求出100个帧里头的前16个最小值。每个最小值都对应一个age，最大不超过100，超过100则失效，用这个最小值来更新噪声；
- 调用WeightedAverage()函数，计算噪声高斯混合模型的均值和方差，计算语音高斯混合模型的均值和方差；
- 对于每一个单高斯模型，进行如下操作：更新每一个噪声高斯模型的均值μ；如果是语音帧，则更新每一个语音高斯模型的均值μ和方差σ；如果不是语音帧，则更新每一个噪声高斯模型的方差σ；
- 根据更新后的模型参数，再次调用WeightedAverage()函数，计算噪声和语音高斯混合模型的均值，比较两个均值的差值。如果小于阈值，则表明两个模型靠的太近，需要进行处理，使两个模型“分开”，分开后再重新计算两个模型的均值μ；
- 对噪声高斯混合模型的均值μ和语音高斯混合模型的均值μ进行最大值限制；

（5）帧数加1

（6）平滑处理，增强鲁棒性输出
